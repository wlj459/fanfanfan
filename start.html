<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>番番番</title>
    <script src="pixi.js"></script>
</head>

<body>
    <script>
        var window_width = document.documentElement.scrollWidth;
        var window_height = document.documentElement.scrollHeight;
        var game_height = window_height;
        var fail = false;
        var success = false;
        var first = null;
        var next = null;
        var game_width = Math.floor(window_height/1.778);
        if (game_width > window_width) {
            game_width = window_width;
            ganke_height = game_width * 1.778;
        }
        var stage = new PIXI.Container();


        var renderer = PIXI.autoDetectRenderer(game_width, game_height);
        document.body.appendChild(renderer.view);

        var sprite_back = PIXI.Sprite.fromImage("img/background@2x.png")
        game_ratio = game_width/375;

        sprite_back.scale.x = sprite_back.scale.y = game_ratio;
        stage.addChild(sprite_back);


        var sprite_grey = PIXI.Sprite.fromImage("img/background-拷贝-2@2x.png");
        sprite_grey.scale.x = sprite_grey.scale.y = game_ratio;

//=======================================================================
        var rank = 1;
        var ready = true;
        var ready_num = 4;
        var start = false;
        var start_num = 15;//00:00
        var stop = false;
        var ans = 8;

        easy_p = new Array();


        for (i=1; i<=3; i++)
        {
            easy_p[i] = new Array();
           for (j=1; j<=3; j++){
               easy_p[i][j] = new Array();
               if (j == 1) {
                   if (i * j == 1) {
                       easy_p[i][j][1] = game_width * 0.013;
                       easy_p[i][j][2] = game_height * 0.257 ;
                   }
                   else {
                       easy_p[i][j][1] = easy_p[i-1][j][1];
                       easy_p[i][j][2] = easy_p[i-1][j][2] + game_height * 0.1889;
                   }
               }
               else{
                   easy_p[i][j][1] = easy_p[i][j-1][1] + game_width * 0.3413;
                   easy_p[i][j][2] = easy_p[i][j-1][2];
               }
           }
        }

        easy_card_list = new Array();
        easy_card = new Array();
        easy_card_list = ['1', '2', '3', '4', '1', '2', '3', '4', '0'];
        easy_chosenTiles = new Array();

        easy_random();
        var texture_easy = PIXI.Texture.fromImage("img/card_back_230@2x.png");

        var easy_back = new Array();
        for (i=1; i<=3; i++){
            easy_back[i] = new Array;
            for (j=1; j<=3; j++){
                easy_back[i][j] = new PIXI.Sprite(texture_easy);
                easy_back[i][j].position.x = easy_p[i][j][1];
                easy_back[i][j].position.y = easy_p[i][j][2];
                easy_back[i][j].scale.x = easy_back[i][j].scale.y = game_ratio;
                easy_back[i][j].buttonMode = true;
                easy_back[i][j].interactive = true;
                easy_back[i][j].isSelected = false;
                easy_back[i][j].i = i;
                easy_back[i][j].j = j;
            }
        }
//---------------------------------------------------
        var sprite_di =  PIXI.Sprite.fromImage("img/第@2x.png");
        sprite_di.scale.x = sprite_di.scale.y = game_ratio;
        sprite_di.position.x = game_width * 0.3693;
        sprite_di.position.y = game_height * 0.1154;


        var style = {
            font : '80px Arial',
            fill : '#4e7e59'
        };

        // 10开始的适配还没做
        var sprite_rank_easy = new PIXI.Text(rank, style);
        sprite_rank_easy.scale.x = sprite_rank_easy.scale.y = game_ratio/2;
        sprite_rank_easy.position.x = game_width * 0.48;
        sprite_rank_easy.position.y = game_height * 0.1054;



        var sprite_guan =  PIXI.Sprite.fromImage("img/關@2x.png");
        sprite_guan.scale.x = sprite_guan.scale.y = game_ratio;
        sprite_guan.position.x = game_width * 0.5547;
        sprite_guan.position.y = game_height * 0.1154;


        var sprite_stop =  PIXI.Sprite.fromImage("img/button_stop@2x.png");
        sprite_stop.scale.x = sprite_stop.scale.y = game_ratio;
        //此处暂时没加按钮
        sprite_stop.position.x = game_width * 0.8627;
        sprite_stop.position.y = game_height * 0.9288;
        stage.addChild(sprite_stop);

        var h = null;
        if (start_num > 9) {
            h = "00:" + String(start_num);
        }
        else {
            h = "00:0" + String(start_num);
        }


        var time_style = {
            font : '40px Arial',
            fill : '#4e7e59'
        };
        var ready_style = {
            font : '80px Arial',
            fill : '#ffffff'
        };
        var sprite_start_num = new PIXI.Text(h, time_style);
        sprite_start_num.scale.x = sprite_start_num.scale.y = game_ratio/2;
        sprite_start_num.position.x = game_width * 0.848;
        sprite_start_num.position.y = game_height * 0.1874;
        stage.addChild(sprite_start_num);

        var sprite_ready_num = new PIXI.Text(ready_num, ready_style);
        sprite_ready_num.scale.x = sprite_ready_num.scale.y = game_ratio/2;
        sprite_ready_num.position.x = game_width * 0.5;
        sprite_ready_num.position.y = game_height * 0.5;

        //==================init================
        back = new Array();
        card = new Array();
        for (i=1;i<=3;i++){
            back[i] = new Array();
            card[i] = new Array();
            back[i] = easy_back[i];
            card[i] = easy_card[i];
        }
        chosenTiles = new Array();
        chosenTiles = easy_chosenTiles;
        card_list = new Array();
        card_list = easy_card_list;
        //======================================

        function back_click(){

            //document.write(this);
            if (this.isSelected == false){
                stage.removeChild(this);
                this.isSelected = true;
                if (first == null){
                    first = this;
                }
                else{
                    next = this;
                }
                if (card_list[chosenTiles[this.i][this.j]]==0){
                    fail = true;
                }
            }
            //animate();
        }

        function easy_random (){
            u = new Array();
            u = [0,0,0,0,0,0,0,0,0];
            for (i=1; i<=3;i++) {
                easy_chosenTiles[i] = new Array();
                easy_card[i] = new Array();
                for (j=1; j<=3;j++) {
                    var candidate=Math.floor(Math.random()*9);
                    while(u[candidate] == 1) {
                        var candidate = Math.floor(Math.random() * 9);
                    }
                    easy_chosenTiles[i][j] = candidate;
                    u[candidate] = 1;
                    easy_card[i][j] = new PIXI.Sprite.fromImage("img/1-" + easy_card_list[candidate] + '.png')
                    easy_card[i][j].position.x = easy_p[i][j][1];
                    easy_card[i][j].position.y = easy_p[i][j][2];
                    easy_card[i][j].scale.x = easy_card[i][j].scale.y = game_ratio/2;
                }
            }
        }
        animate();


        function animate() {

            requestAnimationFrame(animate);
            if (fail){
                window.location.href="index.html";
            }
            else if(success){
                alert(rank);
                if(rank == 5) {
                    window.location.href = "index.html";
                }else{
                    success = false;
                    first = null;
                    next = null;
                    ans = 8;
                    rank += 1;
                    sprite_rank_easy.text = rank;
                    ready = true;
                    start_num = 15;
                    easy_random();
                }
            }
            else if(ready){
                var h = null;
                if (start_num >= 10) {
                    h = "00:" + String(Math.floor(start_num));
                }
                else {
                    h = "00:0" + String(Math.floor(start_num));
                }
                sprite_start_num.text = h;
                if (ready_num == 4) {
                    for(i=1;i<=3;i++) {
                        for(j=1;j<=3;j++){
                            back[i][j].on('touchstart', back_click);
                            back[i][j].on('mousedown', back_click);
                            back[i][j].isSelected = false;
                            stage.addChild(back[i][j]);
                        }
                    }
                    if (rank < 10) {
                        for (i = 1; i <= 3; i++) {
                            for (j = 1; j <= 3; j++) {
                                stage.addChild(easy_card[i][j]);
                            }
                        }
                        stage.addChild(sprite_di);
                        stage.addChild(sprite_rank_easy);
                        stage.addChild(sprite_guan);
                        stage.addChild(sprite_grey);
                    }
                    else {

                    }
                }
                sprite_ready_num.text = Math.floor(ready_num);
                stage.addChild(sprite_ready_num);
                ready_num -= 0.02;
                if (ready_num < 1){
                    ready_num = 4;
                    ready = false;
                    start = true;
                    stage.removeChild(sprite_grey);
                    stage.removeChild(sprite_ready_num);
                    for(i=1;i<=3;i++) {
                        for(j=1;j<=3;j++){
                            stage.addChild(back[i][j]);
                        }
                    }
                    first = null;
                    next = null;
                }
            }
            else if(start){
                var h = null;
                if (start_num >= 10) {
                    h = "00:" + String(Math.floor(start_num));
                }
                else {
                    h = "00:0" + String(Math.floor(start_num));
                }
                sprite_start_num.text = h;
                start_num -= 0.02;
                if (first != null){
                    if (next != null){
                        stage.removeChild(next);
                        if (card_list[chosenTiles[next.i][next.j]] == card_list[chosenTiles[first.i][first.j]]){
                            ans -= 2;
                            if (ans == 0){
                                if (start_num>=0) {
                                    success = true;
                                }
                            }
                        }
                        else {
                            stage.addChild(first);
                            stage.addChild(next);
                            first.isSelected = false;
                            next.isSelected = false;
                        }
                        first = null;
                        next = null;
                    }
                    else {
                        stage.removeChild(first);
                    }
                }
                //===============
                if (start_num <0){
                    if(ans == 0){
                        success = true;
                    }
                    else {
                        fail = true;
                    }
                }
            }
            renderer.render(stage);
        }

    </script>
</body>
</html>